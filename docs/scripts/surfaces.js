var _classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash"),require("two-rotations")):"function"==typeof define&&define.amd?define(["lodash","two-rotations"],e):t.Surface=e(t._,t.twoRotations)}(this,function(t,e){"use strict";function n(t,e){return 1-(t[1]-e)/(t[1]-t[0])}function o(t,e){return t[1]-(1-e)*(t[1]-t[0])}var i=function(){function t(){var e=void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t),this._domain=e.domain,this._range=e.range}return _createClass(t,[{key:"transformTo",value:function(t){var e=n(this._domain,t);return o(this._range,e)}},{key:"transformFrom",value:function(t){var e=n(this._range,t);return o(this._domain,e)}}]),t}(),a=function(){for(var t=void 0===arguments[0]?{}:arguments[0],e=void 0!==t.to?t.to:0,n=t.yDomain,o=t.xDomain,a=t.xResolution,r=t.yResolution,s=t.from,h=(o[1]-o[0])/a,u=(n[1]-n[0])/r,l=new i({domain:[0,h],range:o}),c=new i({domain:[0,u],range:n}),m=[],f=s;e>=f;f++){var v=[];m.push(v);for(var d=0;h>=d;d++){var g=[];v.push(g);for(var y=0;u>=y;y++)g.push(t.fn(l.transformTo(d),c.transformTo(y),f))}}return m},r=function(t,e){for(var n,o=[],i=t.length,a=t[0].length,r=0;i>r;r++){o.push(n=[]);for(var s=0;a>s;s++)e(n,r,s,i,a)}return o},s=function(t){var n,o=t.data,a=t.zoom,s=t.rotationMatrix,h=t.range,u=t.zScale,l=t.xResolution,c=t.xScale,m=t.yResolution,f=t.yScale,v=t.xDomain,d=t.yDomain,g=(v[1]-v[0])/l,y=(d[1]-d[0])/m,p=new i({domain:h,range:[0,u]}),x=new i({domain:[0,g],range:[-c/2,c/2]}),_=new i({domain:[0,y],range:[-f/2,f/2]});return r(o,function(t,i,r){n=[x.transformTo(i)*a,-p.transformTo(o[i][r])*a,_.transformTo(r)*a],t.push(e.rotate(n,s))})},h=function(){var t,e,n,o,i,a=void 0===arguments[0]?{}:arguments[0],s=a.originalData,h=a.data,u=a.width,l=a.height,c=a.range,m=a.zScale,f=u/2,v=l-.5*(l-m),d=[];return r(h,function(a,r,u,l,m){if(r!==l-1&&u!==m-1){t=s[r][u],e=s[r+1][u],n=s[r+1][u+1],o=s[r][u+1],i=.25*(t+e+n+o);var g=c[0],y=c[1];if(!(t>y||e>y||n>y||o>y||g>t||g>e||g>n||g>o)){var p=h[r][u][2]+h[r+1][u][2]+h[r+1][u+1][2]+h[r][u+1][2];d.push({path:{moveTo:[(h[r][u][0]+f).toFixed(10),(h[r][u][1]+v).toFixed(10)],pointOne:[(h[r+1][u][0]+f).toFixed(10),(h[r+1][u][1]+v).toFixed(10)],pointTwo:[(h[r+1][u+1][0]+f).toFixed(10),(h[r+1][u+1][1]+v).toFixed(10)],pointThree:[(h[r][u+1][0]+f).toFixed(10),(h[r][u+1][1]+v).toFixed(10)]},depth:p,avg:i,data:s[r][u]})}}}),d.sort(function(t,e){return e.depth-t.depth}),d},u=["tagName","fn","el","width","height","colorFn","strokeColorFn","zoom","yaw","pitch","xyDomain","xyResolution","xyScale","yDomain","yResolution","yScale","xDomain","xResolution","xScale","range","zScale","maxPitch"],l="http://www.w3.org/2000/svg",c=function(){function n(e){_classCallCheck(this,n),t.defaults(this,t.pick(e,u),{tagName:"canvas",width:300,height:300,zoom:1,yaw:.5,pitch:.5,maxPitch:Math.PI/2,colorFn:function(){return"#333"},strokeColorFn:function(){return"rgba(0,0,0,0.4)"},fn:n.spacetimeOrigin,xyDomain:[-10,10],xyResolution:1,xyScale:300,range:[-10,10],zScale:1}),this._rotationMatrix=[],this._generateRotation(),this._ensureElement(),this._setType()}return _createClass(n,[{key:"_computeData",value:function(){var t=void 0===arguments[0]?{}:arguments[0],e=t.from,n=t.to,o=t.resolution;return a({fn:this.fn,from:e,to:n,resolution:o,xDomain:this.xDomain||this.xyDomain,xResolution:this.xResolution||this.xyResolution,yDomain:this.yDomain||this.xyDomain,yResolution:this.yResolution||this.xyResolution})}},{key:"orient",value:function(e){return t.extend(this,t.pick(e,["yaw","pitch"])),this.pitch=Math.max(-this.maxPitch,Math.min(this.maxPitch,this.pitch)),this._generateRotation(),this}},{key:"render",value:function(){var t=void 0===arguments[0]?{}:arguments[0],e=t.t||0,n=this._computeData({from:e,to:e,resolution:1})[0],o=s({data:n,range:this.range,xScale:this.xScale||this.xyScale,yScale:this.yScale||this.xyScale,xResolution:this.xResolution||this.xyResolution,yResolution:this.yResolution||this.xyResolution,xDomain:this.xDomain||this.xyDomain,yDomain:this.yDomain||this.xyDomain,zScale:this.zScale,zoom:this.zoom,rotationMatrix:this._rotationMatrix}),i=h({originalData:n,data:o,height:this.height,width:this.width,range:this.range,zScale:this.zScale,pitch:this.pitch});return"canvas"===this._type?this._renderCanvasSurface(i):this._renderSvgSurface(i),this}},{key:"_generateRotation",value:function(){this._rotationMatrix=e.generateMatrix(this.yaw,this.pitch)}},{key:"_ensureElement",value:function(){this.el=this.el?t.result(this,"el"):this._createElement(t.result(this,"tagName")),"canvas"===this.el.nodeName.toLowerCase()&&(this.el.width=this.width,this.el.height=this.height)}},{key:"_setType",value:function(){this._type=this.el.nodeName.toLowerCase()}},{key:"_createElement",value:function(t){if("svg"===t)return this._createSvgElement("svg");if("canvas"===t)return document.createElement("canvas");throw new Error("The element must be a canvas or svg.")}},{key:"_renderCanvasSurface",value:function(t){var e=this,n=this.el.getContext("2d");this._clearCanvas(n);var o;t.forEach(function(t){o=t.path,n.beginPath(),n.fillStyle=e.colorFn(t.avg),n.strokeStyle=e.strokeColorFn(t.avg),n.moveTo(Math.round(o.moveTo[0]),Math.round(o.moveTo[1])),n.lineTo(Math.round(o.pointOne[0]),Math.round(o.pointOne[1])),n.lineTo(Math.round(o.pointTwo[0]),Math.round(o.pointTwo[1])),n.lineTo(Math.round(o.pointThree[0]),Math.round(o.pointThree[1])),n.stroke(),n.fill()})}},{key:"_createSvgElement",value:function(t){return document.createElementNS(l,t)}},{key:"_setSvgAttribute",value:function(t,e,n){t.setAttributeNS(null,e,n)}},{key:"_clearCanvas",value:function(t){t.clearRect(0,0,this.el.width,this.el.height)}},{key:"_clearSvg",value:function(){for(;this.el.firstChild;)this.el.removeChild(this.el.firstChild)}},{key:"_renderSvgSurface",value:function(t){var e=this;this._clearSvg();var n,o;t.forEach(function(t){n=t.path,o=e._createSvgElement("path"),e._setSvgAttribute(o,"d",e._generateDAttr(t.path)),e._setSvgAttribute(o,"fill",e.colorFn(t.avg)),e.el.appendChild(o)})}},{key:"_generateDAttr",value:function(t){return"M"+t.moveTo[0]+", "+t.moveTo[1]+"\n      L"+t.pointOne[0]+", "+t.pointOne[1]+"\n      L"+t.pointTwo[0]+", "+t.pointTwo[1]+"\n      L"+t.pointThree[0]+", "+t.pointThree[1]}}]),n}();c.spacetimeOrigin=function(){return[[[0]]]};var m=c;return m});
